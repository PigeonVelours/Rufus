<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyFlow - Suivi Bancaire</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 5px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card h2 { color: #667eea; margin-bottom: 20px; font-size: 1.3em; }
        
        .balance-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .balance-card h2 { color: white; opacity: 0.9; font-size: 1em; font-weight: normal; margin-bottom: 10px; }
        .balance-amount { font-size: 3.5em; font-weight: bold; margin: 15px 0 25px 0; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-box { background: rgba(255,255,255,0.15); padding: 18px; border-radius: 12px; }
        .stat-label { font-size: 0.9em; opacity: 0.85; margin-bottom: 8px; }
        .stat-value { font-size: 1.8em; font-weight: bold; }
        
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; color: #444; font-size: 0.95em; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 14px; border: 2px solid #e5e5e5; border-radius: 12px; font-size: 1em; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .category-actions { display: flex; gap: 8px; }
        .icon-btn { background: #667eea; color: white; border: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .icon-btn:hover { background: #5568d3; transform: translateY(-1px); }
        .icon-btn.delete { background: #e74c3c; }
        .icon-btn.delete:hover { background: #c0392b; }
        
        .btn { width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1.05em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
        .btn:active { transform: translateY(0); }
        
        .budget-item { margin-bottom: 22px; padding: 18px; background: #f8f9fa; border-radius: 12px; transition: all 0.2s; }
        .budget-item:hover { background: #f0f1f3; }
        .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.95em; }
        .budget-category { font-weight: 600; color: #333; }
        .budget-amounts { display: flex; align-items: center; gap: 10px; }
        .budget-bar { height: 14px; background: #e9ecef; border-radius: 10px; overflow: hidden; position: relative; }
        .budget-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.6s ease; border-radius: 10px; }
        .budget-fill.warning { background: linear-gradient(90deg, #f39c12 0%, #e67e22 100%); }
        .budget-fill.danger { background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%); }
        
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
        .transaction-item:hover { background: #f8f9fa; }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-info { flex: 1; }
        .transaction-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; margin-bottom: 6px; }
        .badge-income { background: #d4edda; color: #155724; }
        .badge-expense { background: #f8d7da; color: #721c24; }
        .transaction-desc { color: #555; margin-bottom: 4px; font-size: 0.95em; }
        .transaction-date { color: #999; font-size: 0.85em; }
        .transaction-amount { font-size: 1.3em; font-weight: bold; }
        .amount-income { color: #28a745; }
        .amount-expense { color: #dc3545; }
        
        .empty-state { text-align: center; padding: 50px 20px; color: #999; }
        .empty-icon { font-size: 3.5em; margin-bottom: 15px; opacity: 0.5; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 35px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-header h3 { color: #667eea; font-size: 1.4em; }
        .close-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #999; line-height: 1; }
        .close-btn:hover { color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ MoneyFlow</h1>
            <p>Application de suivi bancaire</p>
        </div>

        <div class="dashboard">
            <!-- TABLEAU DE BORD -->
            <div class="card balance-card">
                <h2>Solde actuel</h2>
                <div class="balance-amount" id="soldeActuel">0,00 ‚Ç¨</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Revenus</div>
                        <div class="stat-value" id="totalRevenus">0,00 ‚Ç¨</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">D√©penses</div>
                        <div class="stat-value" id="totalDepenses">0,00 ‚Ç¨</div>
                    </div>
                </div>
            </div>

            <!-- NOUVELLE TRANSACTION -->
            <div class="card">
                <h2>‚ûï Nouvelle transaction</h2>
                <div class="form-group">
                    <label>Type</label>
                    <select id="transactionType">
                        <option value="revenu">Revenu</option>
                        <option value="depense">D√©pense</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Montant (‚Ç¨)</label>
                    <input type="number" id="transactionMontant" step="0.01" placeholder="0,00">
                </div>
                <div class="form-group">
                    <div class="category-header">
                        <label style="margin:0;">Cat√©gorie</label>
                        <div class="category-actions">
                            <button class="icon-btn" onclick="ajouterCategorie()">‚ûï</button>
                            <button class="icon-btn delete" onclick="supprimerCategorie()">üóëÔ∏è</button>
                        </div>
                    </div>
                    <select id="transactionCategorie"></select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="transactionDesc" placeholder="Ex: Salaire, Courses...">
                </div>
                <button class="btn" onclick="ajouterTransaction()">Ajouter</button>
            </div>
        </div>

        <!-- BUDGET MENSUEL -->
        <div class="card">
            <h2>üìä Budget mensuel</h2>
            <div id="budgetListe"></div>
        </div>

        <!-- HISTORIQUE -->
        <div class="card">
            <h2>üìú Historique</h2>
            <div id="historiqueListe">
                <div class="empty-state">
                    <div class="empty-icon">üí∏</div>
                    <p>Aucune transaction enregistr√©e</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER BUDGET -->
    <div id="modalBudget" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier le budget</h3>
                <button class="close-btn" onclick="fermerModal('modalBudget')">√ó</button>
            </div>
            <div class="form-group">
                <label id="labelCategorieBudget">Cat√©gorie</label>
                <p style="color:#666;margin-bottom:15px;">Montant actuel: <strong id="montantActuelBudget">0 ‚Ç¨</strong></p>
            </div>
            <div class="form-group">
                <label>Nouveau budget (‚Ç¨)</label>
                <input type="number" id="nouveauBudget" step="0.01" placeholder="0,00">
            </div>
            <button class="btn" onclick="mettreAJourBudget()">Mettre √† jour</button>
        </div>
    </div>

    <!-- MODAL AJOUTER CAT√âGORIE -->
    <div id="modalAjouterCategorie" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Ajouter une cat√©gorie</h3>
                <button class="close-btn" onclick="fermerModal('modalAjouterCategorie')">√ó</button>
            </div>
            <div class="form-group">
                <label>Intitul√©</label>
                <input type="text" id="nouvelleCategorienom" placeholder="Ex: Abonnements, Vacances...">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="nouvelleCategorieType">
                    <option value="depense">D√©pense</option>
                    <option value="revenu">Revenu</option>
                </select>
            </div>
            <button class="btn" onclick="ajouterNouvelleCategorie()">Mettre √† jour</button>
        </div>
    </div>

    <!-- MODAL SUPPRIMER CAT√âGORIES -->
    <div id="modalSupprimerCategorie" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üóëÔ∏è Supprimer des cat√©gories</h3>
                <button class="close-btn" onclick="fermerModal('modalSupprimerCategorie')">√ó</button>
            </div>
            <div id="listeCategoriesToDelete" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // DONN√âES
        var categories = [
            'Revenus', 'Alimentation', 'Transport', 'Loisirs', 'Loyer', 
            'Electricit√©', 'Assurance habitation', 'Internet', 'Telephone', 
            'Sant√©', 'Epargne', 'Dettes', 'Autres'
        ];
        
        var budgets = {
            'Revenus': 0,
            'Alimentation': 400,
            'Transport': 200,
            'Loisirs': 150,
            'Loyer': 800,
            'Electricit√©': 100,
            'Assurance habitation': 50,
            'Internet': 40,
            'Telephone': 30,
            'Sant√©': 100,
            'Epargne': 300,
            'Dettes': 200,
            'Autres': 200
        };
        
        var transactions = [];
        var categorieEnCoursDeModif = null;

        // HELPERS
        function euro(n) {
            return n.toFixed(2).replace('.', ',') + ' ‚Ç¨';
        }

        function sauvegarder() {
            localStorage.setItem('moneyflow_data', JSON.stringify({
                categories: categories,
                budgets: budgets,
                transactions: transactions
            }));
        }

        function charger() {
            var data = localStorage.getItem('moneyflow_data');
            if (data) {
                var obj = JSON.parse(data);
                categories = obj.categories || categories;
                budgets = obj.budgets || budgets;
                transactions = obj.transactions || [];
            }
        }

        // CAT√âGORIES
        function mettreAJourSelectCategories() {
            var select = document.getElementById('transactionCategorie');
            var type = document.getElementById('transactionType').value;
            
            select.innerHTML = '';
            
            if (type === 'revenu') {
                // Pour les revenus, afficher seulement "Revenus"
                var opt = document.createElement('option');
                opt.value = 'Revenus';
                opt.textContent = 'Revenus';
                select.appendChild(opt);
            } else {
                // Pour les d√©penses, afficher TOUTES les cat√©gories sauf "Revenus"
                for (var i = 0; i < categories.length; i++) {
                    if (categories[i] !== 'Revenus') {
                        var opt = document.createElement('option');
                        opt.value = categories[i];
                        opt.textContent = categories[i];
                        select.appendChild(opt);
                    }
                }
            }
        }

        function ajouterCategorie() {
            document.getElementById('nouvelleCategorienom').value = '';
            document.getElementById('nouvelleCategorieType').value = 'depense';
            document.getElementById('modalAjouterCategorie').classList.add('active');
        }

        function ajouterNouvelleCategorie() {
            var nom = document.getElementById('nouvelleCategorienom').value.trim();
            var type = document.getElementById('nouvelleCategorieType').value;
            
            if (!nom || nom === '') {
                alert('‚ö†Ô∏è Veuillez saisir un intitul√©');
                return;
            }
            
            if (categories.indexOf(nom) !== -1) {
                alert('‚ö†Ô∏è Cette cat√©gorie existe d√©j√†');
                return;
            }
            
            categories.push(nom);
            budgets[nom] = 0;
            
            sauvegarder();
            actualiserInterface();
            fermerModal('modalAjouterCategorie');
            
            alert('‚úì Cat√©gorie "' + nom + '" ajout√©e !');
        }

        function supprimerCategorie() {
            var html = '';
            
            for (var i = 0; i < categories.length; i++) {
                var cat = categories[i];
                html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:15px;border-bottom:1px solid #f0f0f0;">';
                html += '<span style="font-weight:500;">' + cat + '</span>';
                html += '<button class="icon-btn delete" onclick="confirmerSuppressionCategorie(\'' + cat + '\')">üóëÔ∏è</button>';
                html += '</div>';
            }
            
            document.getElementById('listeCategoriesToDelete').innerHTML = html;
            document.getElementById('modalSupprimerCategorie').classList.add('active');
        }

        function confirmerSuppressionCategorie(cat) {
            if (confirm('Supprimer la cat√©gorie "' + cat + '" ?\n\nToutes les transactions associ√©es seront conserv√©es mais cette cat√©gorie n\'appara√Ætra plus dans le Budget mensuel.')) {
                var idx = categories.indexOf(cat);
                if (idx > -1) {
                    categories.splice(idx, 1);
                    delete budgets[cat];
                    
                    sauvegarder();
                    actualiserInterface();
                    fermerModal('modalSupprimerCategorie');
                    
                    alert('‚úì Cat√©gorie supprim√©e');
                }
            }
        }

        // TRANSACTIONS
        function ajouterTransaction() {
            var type = document.getElementById('transactionType').value;
            var montant = parseFloat(document.getElementById('transactionMontant').value);
            var categorie = document.getElementById('transactionCategorie').value;
            var desc = document.getElementById('transactionDesc').value;

            if (!montant || montant <= 0) {
                alert('‚ö†Ô∏è Montant invalide');
                return;
            }

            if (!desc || desc.trim() === '') {
                alert('‚ö†Ô∏è Description obligatoire');
                return;
            }

            var transaction = {
                id: Date.now(),
                type: type,
                montant: montant,
                categorie: categorie,
                description: desc.trim(),
                date: new Date().toISOString()
            };

            transactions.unshift(transaction);
            sauvegarder();
            actualiserInterface();

            document.getElementById('transactionMontant').value = '';
            document.getElementById('transactionDesc').value = '';
            
            alert('‚úì Transaction ajout√©e !');
        }

        function supprimerTransaction(id) {
            if (confirm('Supprimer cette transaction ?')) {
                for (var i = 0; i < transactions.length; i++) {
                    if (transactions[i].id === id) {
                        transactions.splice(i, 1);
                        break;
                    }
                }
                sauvegarder();
                actualiserInterface();
            }
        }

        // BUDGET
        function ouvrirModalBudget(categorie) {
            categorieEnCoursDeModif = categorie;
            document.getElementById('labelCategorieBudget').textContent = categorie;
            document.getElementById('montantActuelBudget').textContent = euro(budgets[categorie] || 0);
            document.getElementById('nouveauBudget').value = budgets[categorie] || 0;
            document.getElementById('modalBudget').classList.add('active');
        }

        function mettreAJourBudget() {
            var nouveau = parseFloat(document.getElementById('nouveauBudget').value);
            
            if (nouveau >= 0 && categorieEnCoursDeModif) {
                budgets[categorieEnCoursDeModif] = nouveau;
                sauvegarder();
                actualiserInterface();
                fermerModal('modalBudget');
                alert('‚úì Budget mis √† jour !');
            } else {
                alert('‚ö†Ô∏è Montant invalide');
            }
        }

        function fermerModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // INTERFACE
        function actualiserInterface() {
            // CALCULS
            var totalRev = 0;
            var totalDep = 0;
            var depensesParCategorie = {};

            for (var i = 0; i < transactions.length; i++) {
                var t = transactions[i];
                if (t.type === 'revenu') {
                    totalRev += t.montant;
                } else {
                    totalDep += t.montant;
                    depensesParCategorie[t.categorie] = (depensesParCategorie[t.categorie] || 0) + t.montant;
                }
            }

            var solde = totalRev - totalDep;

            // TABLEAU DE BORD
            document.getElementById('soldeActuel').textContent = euro(solde);
            document.getElementById('totalRevenus').textContent = euro(totalRev);
            document.getElementById('totalDepenses').textContent = euro(totalDep);

            // BUDGET MENSUEL - CORRECTION ‚úÖ
            var budgetHTML = '';
            for (var i = 0; i < categories.length; i++) {
                var cat = categories[i];
                if (cat === 'Revenus') continue;
                
                var depense = depensesParCategorie[cat] || 0;
                var budget = budgets[cat] || 0;
                
                // ‚úÖ CORRECTION: Calculer le pourcentage m√™me si budget = 0
                var pct = 0;
                if (budget > 0) {
                    pct = Math.min((depense / budget) * 100, 100);
                } else if (depense > 0) {
                    // Si pas de budget mais il y a des d√©penses, mettre 100%
                    pct = 100;
                }
                
                var classe = pct > 90 ? 'danger' : (pct > 70 ? 'warning' : '');

                budgetHTML += '<div class="budget-item">';
                budgetHTML += '<div class="budget-header">';
                budgetHTML += '<div class="budget-category">' + cat + '</div>';
                budgetHTML += '<div class="budget-amounts">';
                // ‚úÖ CORRECTION: Utiliser euro() pour les deux montants
                budgetHTML += '<span>' + euro(depense) + ' / ' + euro(budget) + '</span>';
                budgetHTML += '<button class="icon-btn" onclick="ouvrirModalBudget(\'' + cat + '\')">‚úèÔ∏è</button>';
                budgetHTML += '</div>';
                budgetHTML += '</div>';
                budgetHTML += '<div class="budget-bar">';
                budgetHTML += '<div class="budget-fill ' + classe + '" style="width:' + pct + '%"></div>';
                budgetHTML += '</div>';
                budgetHTML += '</div>';
            }
            document.getElementById('budgetListe').innerHTML = budgetHTML;

            // HISTORIQUE
            var histoHTML = '';
            if (transactions.length === 0) {
                histoHTML = '<div class="empty-state"><div class="empty-icon">üí∏</div><p>Aucune transaction</p></div>';
            } else {
                for (var i = 0; i < transactions.length; i++) {
                    var t = transactions[i];
                    var d = new Date(t.date);
                    var isRev = t.type === 'revenu';
                    
                    histoHTML += '<div class="transaction-item">';
                    histoHTML += '<div class="transaction-info">';
                    histoHTML += '<div class="transaction-badge ' + (isRev ? 'badge-income' : 'badge-expense') + '">' + t.categorie + '</div>';
                    histoHTML += '<div class="transaction-desc">' + t.description + '</div>';
                    histoHTML += '<div class="transaction-date">' + d.toLocaleDateString('fr-FR') + '</div>';
                    histoHTML += '</div>';
                    histoHTML += '<div style="display:flex;align-items:center;gap:12px;">';
                    histoHTML += '<div class="transaction-amount ' + (isRev ? 'amount-income' : 'amount-expense') + '">';
                    histoHTML += (isRev ? '+' : '-') + euro(t.montant);
                    histoHTML += '</div>';
                    histoHTML += '<button class="icon-btn delete" onclick="supprimerTransaction(' + t.id + ')">üóëÔ∏è</button>';
                    histoHTML += '</div>';
                    histoHTML += '</div>';
                }
            }
            document.getElementById('historiqueListe').innerHTML = histoHTML;

            // SELECT CAT√âGORIES
            mettreAJourSelectCategories();
        }

        // INIT
        charger();
        actualiserInterface();
        
        document.getElementById('transactionType').onchange = mettreAJourSelectCategories;
    </script>
</body>
</html>
